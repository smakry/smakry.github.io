---
layout: post
title: 'RPC'
date: 2020-03-01
author: smakry
tags: rpc 阅读笔记
---

> 微服务桥梁

### GORPC

微服务之间需要相互调用和通讯，一般采用RPC来实现不同语言不通服务间的调用和通讯。  

什么是RPC
========
RPC（Remote Procedure Call，远程过程调用），也就是两台服务器A、B，一个应用部署在A服务器，想要调用B服务器上的应用提供的函数方法，由于不在一个内存空间，不能直接调用，需要通过网络来表达调用的语义和传达调用的数据。  

为什么需要RPC
===========
因为RPC是分布式系统中不同节点间流行的通讯方式，在互联网时代，RPC和IPC（Inter-ProcessCommunication，进程间通讯）一样成为不可或缺的基础构建，在Go语言的标准库也提供了简单的RPC的实现。

RPC框架的特点  
===========
所谓特点就是能够满足哪些需求，RPC要实现微服务间的调用和通信需要满足以下需求：  
- 序列化，语言单一（数据结构编码gob全称Go binary，golang自带的数据结构序列化编码/解码工具）  
- 上下文管理（超时控制）  
- 拦截器（鉴权、统计和限流）
- 跨语言
- 服务注册  

*Call ID*：由于客户端和服务端运行在不同进程，为了让客户端和服务端都了解调用了哪个函数，需要在两端维护一个函数到Call ID的映射表，客户端根据表获取函数的Call ID，发起请求，服务端根据Call ID来执行对应的函数，返回值给客户端。  
*序列化和反序列化*：在`本地调用`时候函数是从栈中获取参数运行函数。而在`远程调用`时候，如果需要在不同语言间相互调用函数，需要将参数进行序列化然后以字节流方式传递给服务端，服务端在反序列化来得到参数。  
*网络传输*：客户端和服务端间的调用往往是通过网络完成，只要能传递数据就行，与协议无关，可以使用TCP或UDP，gRcp使用HTTP2。  

RPC在服务间调用流程
================

![RPC在服务间调用流程](https://github.com/smakry/smakry.github.io/raw/master/imags/RPC%E5%9C%A8%E6%9C%8D%E5%8A%A1%E9%97%B4%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B.png)

1.调用客户端句柄，执行传送参数。  
2.调用本地系统内核发送网络消息。  
3.消息传送至远程机器。   
4.服务器句柄得到消息并取得参数。
5.执行远程过程。
6.执行过程将结果返回给服务器句柄。
7.服务器句柄返回结果，调用远程系统内核。  
8.消息传回本地机器。
9.客户端句柄由内核接收消息。  
10.客户端接收句柄返回的数据。  

Go语言RPC实例
===========
<https://blog.csdn.net/qun_y/article/details/89598014> 


### gRPC

1. 数据流
gRPC中的stream就是一种流，可以不断的推送数据，适合传输大数据，或者客户端服务端长时间交互，比如客户端可以向服务端订阅一个数据，服务端就可以利用stream源源不断推送数据


2. gRPC四种数据流
- 简单模式
最传动，客户端发起一次请求，服务端响应一次数据

- 服务端数据流模式
客户端发起一次请求，服务端返回一段连续的数据流，典型的股票，客户端发起请求一个股票，服务端把股票的实时数据源源不断的返回给客户端

- 客户端数据流模式
客户端源源不断向服务端发送数据流，在发送结束后，由服务端返回一个响应。典型的物联网终端向服务器报送数据

- 双向数据流模式
双端可以向对方发送数据流，可以实现实时交互，典型的例子聊天机器人


https://www.grpc.io/docs/languages/go/quickstart/

```shell
export PATH="$PATH:$(go env GOPATH)/bin"
protoc --go_out=. --go-grpc_out=. proto/*.proto
```























