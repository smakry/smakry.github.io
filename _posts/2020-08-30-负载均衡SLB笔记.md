---
layout: post
title: '负载均衡SLB'
date: 2020-08-30
author: smakry
tags: 负载均衡 SLB 笔记
---

> 均衡减压用户流量

### 负载均衡

负载均衡（Load Balancer）是指把用户访问的流量，通过“负载均衡器”（硬件或者软件），根据某种转发的策略，均匀的分发到后端多台服务器上，后端的服务器可以独立的响应和处理请求，从而实现分散负载的效果。负载均衡技术提高了系统的服务能力，增加了应用的可用性。

### 负载均衡方案

1.基于DNS负载均衡（简单，地域上的流量均衡）
原理：用户访问域名，先向DNS服务器解析域名对应的IP地址，让DNS服务器根据不同的地理位置的用户返回不同的IP（例如：就近区域返回）。
优势：配置简单，实现成本非常低，无需额外的开发和维护工作。
缺点：当配置修改后，生效不及时。这个是由于DNS特性导致，DNS多级缓存，当修改了DNS配置后，存在缓存导致IP变更不及时（变更了配置不可能广播所有更新缓存），影响了负载效果。
局限性：一般基于DNS负载的也就是IP轮询或者基于地域的负载策略，没有更高级策略。

2.基于硬件负载均衡（昂贵，主要用于大型服务器集群）
硬件负载就需要设备（比如F5 Network Big-IP，可以理解类似网络交换机）。完全通过硬件来抗压力，性能非常好。
优点：性能强大，算法方面支持很多灵活的策略，同时还具有一些防火墙安全功能。
缺点：贵

3.基于软件负载均衡（相对复杂较便宜，基于机器层面的负载均衡）
使用软件的方式来分发和均衡流量，分为7层协议和4层协议。
网络协议有7层，`基于第四层`“传输层”来做流量分发的方案成为4层负载均衡（例如LVS），而`基于第7层`“应用层”来做流量分发的称为7层负载均衡（例如Nginx）。
基于传输层的性能要高一点。
优点：便宜，在正常服务器上部署即可，无需额外采购，需要投入一点技术优化（互联网常用）。

### 常用的均衡算法 <https://z.itpub.net/article/detail/521FC68829D4E355176D585BFFFDFB50>

1.随机策略
使用随机数来决定转发到哪台机器上，只有数据量达到一定数量，才能真正体现，需要服务器相应效率基本一致

2.轮询策略
请求到达后每个服务器的请求数量平均，当集群中服务器硬件配置不同，性能差别大时，无法区别对待，引出下负载度策略。

3.负载度策略（加权轮询）
机器性能不同，负载不同，需要增加权重使得“均衡”相对平均。

4.相应策略（例如最近最少使用）
记录每个应用服务器正在处理的连接数，然后将新来的请求转发到最少的那台上。

5.哈希策略（源地址散列）
根据请求的来源IP进行hash计算，然后对应到一个服务器上，之后所有来自这个IP请求的都由同一台服务器处理。

6.加权随机
根据权重随机（权重可能来自性能，或者地域等）

### 负载均衡实现在不同的网络模型

1. 二层负载均衡
工作在数据链路层，通信协议的数据链路层修改mac地址进行负载，原本发到当前ip机器的，修改mac指向后端真正的服务mac，同时只能单向返回不再经过ip机器

2. 三层负载均衡
基于网络层的负载均衡，按照不同的机器不同ip地址进行转发请求到不同的机器上

3. 四层负载均衡
通过报文中的目标地址和端口，再加上负载均衡设备设置的服务器选择方式，决定终选择的内部服务器。

4. 七层负载均衡
也称“内容交换”，主要通过报文中的真正有意义的应用层内容，再加上负载均衡设备设置的服务器选择方式，决定最终选择的内部服务器。七层负载均衡器需要跟客户端及服务端的服务实例分别建立连接























